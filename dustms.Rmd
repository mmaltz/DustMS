---
title: "dust"
author: "C. Nell"
date: "7/23/2018"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
    toc_depth: 4
    df_print: paged 
---

```{r, include=FALSE}
knitr::opts_chunk$set(error = TRUE, eval = TRUE, message = FALSE, warning = FALSE, rows.print=5, cols.min.print=4)
```

```{r Load preliminary packages}
library(dplyr) ## for data wrangling - %>% function
library(reshape2) ##melt and cast data
library(tidyr) # 'separate' function
library(readxl) #read xlsx files into r on mac computer
library(vegan) # dissimilarity matrix, permanova functions
library(tidyverse)
library(stringr)
library(ggplot2) # plotting
library(magrittr)
```
### Logic   

**Background:** Dust entering the Sierras comes from both regional and global sources -- and the contribution of each source changes over time. There is evidence that microbial communities can differ based on dust source and timing of dust deflation, and that this can have subsequent effects on endophytic associations (Caroline Frank’s work) and soil microbial communities at the deposition location. We therefore wanted to know:  
  
###**Q1. Do dust-associated microbial communities entering the Sierra Nevada differ across space and time?**   

####Outputs:   
####1. Determine the number of new OTUs identified at each site per sampling event  
####2. NMDS of unweighted unifrac or jaccard dissimilarity. PERMANOVA with PERMDISP. 
*Limitation: our time comparisons may be skewed because we did not sterilize collectors in between sampling events. Time points may appear more similar to each other than in reality. It’s also important to run on presence-absence data only; we don’t want to capture community differences that are driven by post-depositional divergence in relative abundances.*  

```{r read in mapping data}
# wd is set to "/Users/maltz/Documents/GitHub/DustMS_Rmarkdown" which contains this file and all other linked files (or should)
getwd()
# i made a folder in this directory named data where I left it
list.files('data')

map6<-read.csv("data/SierraMap6.csv", header = TRUE, col.names =   c("SampleID","BarcodeSequence","LinkerPrimerSequence","Year","Month","SiteCode","RepNum","SiteRep","Site","Elevation","DateCode","DescName","Description"))

# print df
map6
```

```{r}
# I don't have the same files referenced in DustAnnotated1.1
B16S<-read.csv("data/filtered_table_w_metadata.csv", header = TRUE, stringsAsFactors = FALSE)
head(B16S)
```  
#### Split taxonomy  
```{r separate taxonomy}
head(B16S$taxonomy)

# extract the string between k__ and ; for the kingdoms
B16S$kingdom<-str_match(B16S$taxonomy, "k__(.*?);")[,2]
head(B16S$kingdom)

# do the same for other taxa groupings 
B16S$phylum<-str_match(B16S$taxonomy, "p__(.*?);")[,2]
B16S$class<-str_match(B16S$taxonomy, "c__(.*?);")[,2]
B16S$order<-str_match(B16S$taxonomy, "o__(.*?);")[,2]
B16S$family<-str_match(B16S$taxonomy, "f__(.*?);")[,2]
B16S$genus<-str_match(B16S$taxonomy, "g__(.*?);")[,2]
B16S$species<-str_match(B16S$taxonomy, "s__(.*?)")[,2]

```
```{r split taxa function}
# would be useful to have afunction that does this if data frequently in same format
split_taxa<-function(df, col='taxonomy'){
  df$kingdom<-str_match(df[,col], "k__(.*?);")[,2]
  df$phylum<-str_match(df[,col], "p__(.*?);")[,2]
  df$class<-str_match(df[,col], "c__(.*?);")[,2]
  df$order<-str_match(df[,col], "o__(.*?);")[,2]
  df$family<-str_match(df[,col], "f__(.*?);")[,2]
  df$genus<-str_match(df[,col], "g__(.*?);")[,2]
  df$species<-str_match(df[,col], "s__(.*?)")[,2]
  return(df)
}

splitdf<-split_taxa(df=B16S)
head(splitdf)

```  
```{r}
# to use this in the future - create an rscript to store functions 
# then you can call upon it in any rscript and reuse the same functions without copy/pasting 

source('dust_functions.R')

```
  
#### Read in unifrac distances    
```{r}
list.files('data')
unifrac<-read.table('data/unweighted_unifrac_dm.txt')
unifrac_wt<-read.table('data/weighted_unifrac_dm.txt')
#rows and col reflect pairwise distances?

```

```{r}
## plot otu unifrac dissimilarities as heatmap

# first melt df so there is a new row for every pairwise combo
colnames(unifrac)

unifrac.melt<-unifrac%>%melt(variable.name='otu_1')%>%mutate(otu_2 = rep.int(colnames(unifrac), times=length(colnames(unifrac))))

ggplot(data = unifrac.melt, aes(x = otu_1, y = otu_2))+ geom_tile(aes(fill = value))

```  
```{r}
#recreate plot but rotate x-axis titles so legible

```  

```{r}
# changing color scales

ggplot(data = unifrac.melt, aes(x = otu_1, y = otu_2))+ 
  geom_tile(aes(fill = value))+
  scale_fill_gradient2(low = 'midnightblue', mid='deepskyblue3', high='yellow', midpoint = .5)

# high color indicates samples that were more similar to one another based on unifrac dissimilarity, blue = contains no similarities  

##reorder axis so grouped by more similar samples
ggplot(data = unifrac.melt, aes(x = reorder(otu_1, value), y = reorder(otu_2, value)))+ 
  geom_tile(aes(fill = value))+
  scale_fill_gradient2(low = 'midnightblue', mid='deepskyblue3', high='yellow', midpoint = .5)

## rename axis labels

```
```{r}
# make the same plot for weighted unifrac, compare

```  

```{r}



```

###**Q2. If differences exist, are there particular taxa that contribute disproportionately to those differences?**    
*Note: Can’t run any analyses that rely on relative abundance data (e.g., simper), Address using absence-presence data*   
  
#### Outputs:  

####1. Indicator species analysis to identify taxon-habitat association patterns.  
This procedure identifies OTUs as indicator species independently from their abundance in the total data set. 
####Steps (from https://www.nature.com/articles/ismej2015238):   

  a. single- and doubleton OTUs are removed as they hold little indicator informationusing the multipatt function (number of permutations=9999) implemented in the indicspecies R package (De Cáceres et al., 2010). 
  b. To account for multiple testing, P-values were corrected by calculating false discovery rates (q-values) with the q-value function implemented in the BiocLite R package (Dabney and Storney, 2014). Indicator OTUs with q<0.05 were considered significant. 
  c. Indicator taxa were represented in bipartite networks by using the edge-weighted spring embedded algorithm layout implemented in Cytoscape v.3.0.2 (Shannon et al., 2003) where point biserial correlation values, a measure of species–habitat association, were used to weight the edges between nodes constituting the habitats and indicator OTUs (Hartmann et al., 2015). 
  d. We further mapped these indicator OTUs on taxonomic networks generated in Cytoscape v.3.0.2 to investigate potential taxa–habitat associations (Hartmann et al., 2015). I
  e. Indicator OTUs classified at the genus level were displayed in a taxonomic tree generated in iTOL (Letunic and Bork, 2011) together with the positive point biserial correlation values associated with each habitat.  
  f. To find patterns of co-occurrence among OTUs characteristic of the habitats studied, we analysed correlations among the relative abundances of all indicator OTUs (co-correlations) by calculating Spearman rank correlation values (Spearman, 1904) in R with the function corr.test implemented in the package psych. Multiple testing was accounted for by correcting P-values with a false discovery rates of 5% (q-value<0.05).  
  g. Bacterial and fungal indicator OTUs that were significantly co-correlated were displayed in networks with the edge-weighted spring embedded algorithm layout implemented in Cytoscape where Spearman correlation values were used to weight the edges between the nodes representing the OTUs (Hartmann et al., 2015).”   

it teruherfgbwegrgterfghgfhgf

###**Q3. Can the observed variation in XXX be explained by provenance? By nutrient composition?**
####Outputs: 
####1. Multiple regression on distance matrix  

